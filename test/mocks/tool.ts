import { env } from 'cloudflare:test';
import { vi } from 'vitest';

import { createLogger } from '../../src/utils/logger';

import type { MemorySystem } from '../../src/echo/memory-system';
import type { ToolContext } from '../../src/llm/openai/functions';
import type { EchoInstanceConfig } from '../../src/types/echo-config';

export const mockStorage = {
  get: vi.fn(),
  put: vi.fn(),
  delete: vi.fn(),
  list: vi.fn(),
  deleteAll: vi.fn(),
  getAlarm: vi.fn(),
  setAlarm: vi.fn(),
  deleteAlarm: vi.fn(),
  sync: vi.fn(),
  transaction: vi.fn(),
  sql: {
    exec: vi.fn(),
    databaseSize: 0,
    Cursor: vi.fn(),
    Statement: vi.fn(),
  },
  transactionSync: vi.fn(),
  getCurrentBookmark: vi.fn(),
  getBookmarkForTime: vi.fn(),
  onNextSessionRestoreBookmark: vi.fn(),
};

const mockLogger = createLogger(env);
vi.spyOn(mockLogger, 'debug').mockImplementation(vi.fn());
vi.spyOn(mockLogger, 'info').mockImplementation(vi.fn());
vi.spyOn(mockLogger, 'warn').mockImplementation(vi.fn());
vi.spyOn(mockLogger, 'error').mockImplementation(vi.fn());

const mockMemorySystem: MemorySystem = {
  storeMemory: vi.fn(),
  searchMemory: vi.fn().mockResolvedValue([]),
} as unknown as MemorySystem;

export const mockInstanceConfig: EchoInstanceConfig = {
  id: 'rin',
  name: 'テスト用リン',
  systemPrompt: 'Test system prompt',
  discordBotToken: 'mock-discord-token',
  chatChannelId: 'mock-chat-channel-id',
  thinkingChannelId: 'mock-thinking-channel-id',
};

export const mockToolContext: ToolContext = {
  instanceConfig: mockInstanceConfig,
  storage: mockStorage as unknown as DurableObjectStorage,
  memorySystem: mockMemorySystem,
  logger: mockLogger,
};
